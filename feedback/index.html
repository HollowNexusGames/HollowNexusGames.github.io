<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Feedback — Hollow Nexus</title>
    <link rel="stylesheet" href="../style.css" />
  </head>

  <body>
    <div class="container subpage">
      <header class="sub-header">
        <a href="../" class="sub-logo-link" aria-label="Hollow Nexus Home">
          <img class="sub-logo" src="../assets/Circle Logo 2.png" alt="Hollow Nexus" />
        </a>

        <nav class="sub-nav" aria-label="Site">
          <a href="../">Home</a>
          <a href="../games/">Games</a>
          <a href="../press/">Press</a>
          <a href="../about/">About</a>
        </nav>
      </header>

      <main>
        <section class="card">
          <h2>Feedback</h2>
          <p class="muted">Thank you! This goes directly to the dev.</p>

          <div class="divider"></div>

          <!-- Form view -->
          <div id="form-view">
            <form id="feedback-form">
              <input type="text" name="honey" id="honey" style="display:none" autocomplete="off" />

              <p><strong>Name (optional)</strong></p>
              <p>
                <input id="name" type="text" autocomplete="name" placeholder="Your name" />
              </p>

              <p><strong>Email (optional)</strong></p>
              <p class="muted">Only if you want a response.</p>
              <p>
                <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />
              </p>

              <div class="divider"></div>

              <p><strong>Game</strong></p>
              <p>
                <select id="game" required>
                  <option value="">Select…</option>
                  <option value="Haute Garbage">Haute Garbage</option>
                </select>
              </p>

              <p><strong>Build / Version</strong></p>
              <p class="muted">Example: Playtest, Demo, Beta, 1.0</p>
              <p>
                <input id="build" type="text" required placeholder="Playtest" />
              </p>

              <div class="divider"></div>

              <p><strong>Type</strong></p>
              <p>
                <select id="category" required>
                  <option value="">Select…</option>
                  <option value="Bug Report">Bug Report</option>
                  <option value="Graphical & User Interface">Graphical & User Interface</option>
                  <option value="Feature Request">Feature Request</option>
                  <option value="User Experience">User Experience</option>
                </select>
              </p>

              <p><strong>Subtype</strong></p>
              <p>
                <select id="subcategory" required>
                  <option value="">Select a Type first…</option>
                </select>
              </p>

              <p><strong>Details</strong></p>
              <p>
                <textarea
                  id="details"
                  rows="6"
                  required
                  placeholder="What happened? What did you expect? Steps to reproduce?"
                ></textarea>
              </p>

              <div class="divider"></div>

              <p><strong>Did you enjoy your time playing?</strong></p>
              <p>
                <select id="enjoyed" required>
                  <option value="">Select…</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                  <option value="Unsure">Unsure</option>
                </select>
              </p>

              <p><strong>Would you play it again?</strong></p>
              <p>
                <select id="playAgain" required>
                  <option value="">Select…</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                  <option value="Unsure">Unsure</option>
                </select>
              </p>

              <p><strong>Would you recommend it to a friend?</strong></p>
              <p>
                <select id="recommend" required>
                  <option value="">Select…</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                  <option value="Unsure">Unsure</option>
                </select>
              </p>

              <p><strong>Anything else?</strong></p>
              <p>
                <textarea id="extra" rows="4" placeholder="Optional"></textarea>
              </p>

              <div class="divider"></div>

              <p><strong>Screenshot (optional)</strong></p>
              <p class="muted">PNG/JPG recommended. Keep it under ~8MB.</p>
              <p>
                <input id="screenshot" type="file" accept="image/png,image/jpeg" />
              </p>

              <div class="divider"></div>

              <p>
                <button
                  type="submit"
                  style="font:inherit; color:var(--umber); background:rgba(248,247,255,0.52); border:1px solid rgba(86,49,20,0.22); padding:10px 14px; border-radius:999px; cursor:pointer;"
                >
                  Submit Feedback
                </button>
              </p>
            </form>
          </div>

          <!-- Thank you view -->
          <div id="thankyou-view" style="display:none;">
            <h2>Thank you!</h2>
            <p class="muted">Your feedback has been sent.</p>
            <p>
              Submission ID:
              <strong id="submission-id"></strong>
            </p>

            <div class="divider"></div>

            <p class="muted">If you need to reference this report later, keep that ID.</p>

            <p style="margin-top:16px;">
              <a class="inline" href="../games/">Back to Games</a>
              &nbsp;·&nbsp;
              <a class="inline" href="#" id="send-another">Send another</a>
            </p>
          </div>
        </section>
      </main>

      <footer>
        © <span id="year"></span> Hollow Nexus. All rights reserved.
      </footer>
    </div>

    <script>
      document.getElementById("year").textContent = String(new Date().getFullYear());
    </script>

    <script>
      const ENDPOINT_URL =
        "https://script.google.com/macros/s/AKfycbzACEqiw5gQaTZWEW6Xg8E_OmZC_lFH5zjVwMRKiG-9Hhk90palta1hHJHxva9XUlI/exec";

      const SUBTYPES = {
        "Bug Report": ["Crashes", "Freeze or Lag", "Visual or Graphical Glitch", "Audio", "Other"],
        "Graphical & User Interface": ["HUD", "Menus", "Buttons", "Sizing", "Other"],
        "Feature Request": ["Elaborate"],
        "User Experience": ["Navigation & Controls", "Game Feel & Accessibility", "Auditory Feedback", "Other"],
      };

      function setSubtypes(category) {
        const sub = document.getElementById("subcategory");
        sub.innerHTML = "";

        const list = SUBTYPES[category] || [];
        if (list.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Select a Type first…";
          sub.appendChild(opt);
          return;
        }

        const first = document.createElement("option");
        first.value = "";
        first.textContent = "Select…";
        sub.appendChild(first);

        for (const item of list) {
          const opt = document.createElement("option");
          opt.value = item;
          opt.textContent = item;
          sub.appendChild(opt);
        }
      }

      function makeClientKey() {
        // stable-ish per browser, used only for rate limiting bucket
        const keyName = "hn_feedback_client_key";
        let key = localStorage.getItem(keyName);
        if (!key) {
          key = "ck_" + Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
          localStorage.setItem(keyName, key);
        }
        return key;
      }

      function makeClientSubmissionId() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let out = "HN-";
        for (let i = 0; i < 8; i++) {
          out += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return out;
      }

      async function fileToDataUrl(file) {
        return await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(String(reader.result));
          reader.onerror = () => reject(new Error("File read failed"));
          reader.readAsDataURL(file);
        });
      }

      document.getElementById("category").addEventListener("change", (e) => {
        setSubtypes(e.target.value);
      });

      document.getElementById("send-another").addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("thankyou-view").style.display = "none";
        document.getElementById("form-view").style.display = "block";
        document.getElementById("feedback-form").reset();
        setSubtypes("");
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      document.getElementById("feedback-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const fileInput = document.getElementById("screenshot");
        const file = fileInput.files && fileInput.files.length > 0 ? fileInput.files[0] : null;

        let screenshot = null;
        if (file) {
          const maxBytes = 8 * 1024 * 1024;
          if (file.size > maxBytes) {
            alert("Screenshot too large. Please keep under ~8MB.");
            return;
          }

          const dataUrl = await fileToDataUrl(file);
          screenshot = {
            filename: file.name,
            mime: file.type,
            data: dataUrl,
          };
        }

        const submissionId = makeClientSubmissionId();

        const payload = {
          honey: document.getElementById("honey").value,

          submissionId: submissionId,
          clientKey: makeClientKey(),

          name: document.getElementById("name").value,
          email: document.getElementById("email").value,

          game: document.getElementById("game").value,
          build: document.getElementById("build").value,

          category: document.getElementById("category").value,
          subcategory: document.getElementById("subcategory").value,
          details: document.getElementById("details").value,

          enjoyed: document.getElementById("enjoyed").value,
          playAgain: document.getElementById("playAgain").value,
          recommend: document.getElementById("recommend").value,
          extra: document.getElementById("extra").value,

          screenshot: screenshot,
        };

        try {
          // CORS-safe submit for GitHub Pages -> Apps Script
          await fetch(ENDPOINT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            mode: "no-cors",
          });

          // We can't read the response in no-cors mode, so show the client ID.
          document.getElementById("submission-id").textContent = submissionId;
          document.getElementById("form-view").style.display = "none";
          document.getElementById("thankyou-view").style.display = "block";
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (err) {
          alert("Failed to submit. Please try again.");
        }
      });
    </script>
  </body>
</html>