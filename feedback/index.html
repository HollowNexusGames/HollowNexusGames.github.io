<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Feedback — Hollow Nexus</title>
    <link rel="stylesheet" href="../style.css" />
  </head>

  <body>
    <div class="container subpage">
      <header class="sub-header">
        <a href="../" class="sub-logo-link" aria-label="Hollow Nexus Home">
          <img class="sub-logo" src="../assets/Circle Logo 2.png" alt="Hollow Nexus" />
        </a>

        <nav class="sub-nav" aria-label="Site">
          <a href="../">Home</a>
          <a href="../games/">Games</a>
          <a href="../press/">Press</a>
          <a href="../about/">About</a>
        </nav>
      </header>

      <main>
        <section class="card">
          <div id="feedback-intro">
            <h2 class="page-title">Player Feedback Form</h2>
            <p class="muted">
              All feedback is greatly appreciated, as it helps the dev improve the game for everyone.
            </p>
            <div class="divider"></div>
          </div>

          <!-- Form view -->
          <div id="form-view">
            <form id="feedback-form" novalidate>
              <input type="text" name="honey" id="honey" style="display:none" autocomplete="off" />

              <p><strong>Name (optional)</strong></p>
              <p>
                <input id="name" type="text" autocomplete="name" placeholder="Your name" />
              </p>

              <p><strong>Email (optional)</strong></p>
              <p class="muted">Only if you want a response.</p>
              <p>
                <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />
              </p>

              <div class="divider"></div>

              <p><strong>Game</strong></p>
              <p>
                <select id="game" required>
                  <option value="">Select…</option>
                  <option value="Haute Garbage">Haute Garbage</option>
                </select>
              </p>

              <p><strong>Build / Version</strong></p>
              <p class="muted">Example: Playtest, Demo, Beta, 1.0</p>
              <p>
                <input id="build" type="text" required placeholder="Playtest" />
              </p>

              <div class="divider"></div>

              <p><strong>Type</strong></p>
              <p>
                <select id="category" required>
                  <option value="">Select…</option>
                  <option value="Bug Report">Bug Report</option>
                  <option value="Graphical & User Interface">Graphical & User Interface</option>
                  <option value="Feature Request">Feature Request</option>
                  <option value="User Experience">User Experience</option>
                </select>
              </p>

              <p><strong>Subtype</strong></p>
              <p>
                <select id="subcategory" required>
                  <option value="">Select a Type first…</option>
                </select>
              </p>

              <p><strong>Details</strong></p>
              <p>
                <textarea
                  id="details"
                  rows="6"
                  required
                  placeholder="What happened? What did you expect? Steps to reproduce?"
                ></textarea>
              </p>

              <div class="divider"></div>

              <p><strong>Did you enjoy your time playing?</strong></p>
              <p>
                <select id="enjoyed" required>
                  <option value="">Select…</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                  <option value="Unsure">Unsure</option>
                </select>
              </p>

              <p><strong>Would you play it again?</strong></p>
              <p>
                <select id="playAgain" required>
                  <option value="">Select…</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                  <option value="Unsure">Unsure</option>
                </select>
              </p>

              <p><strong>Would you recommend it to a friend?</strong></p>
              <p>
                <select id="recommend" required>
                  <option value="">Select…</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                  <option value="Unsure">Unsure</option>
                </select>
              </p>

              <p><strong>How would you rate your overall experience?</strong></p>
              <fieldset class="rating" aria-label="Overall experience rating">
                <legend class="sr-only">Overall experience rating</legend>

                <input type="radio" name="rating" id="rate-green" value="Green" required />
                <label for="rate-green" class="rating-btn" title="Great">
                  <img src="assets/emoticons-green.png" alt="Great" />
                </label>

                <input type="radio" name="rating" id="rate-blue" value="Blue" />
                <label for="rate-blue" class="rating-btn" title="Good">
                  <img src="assets/emoticons-blue.png" alt="Good" />
                </label>

                <input type="radio" name="rating" id="rate-yellow" value="Yellow" />
                <label for="rate-yellow" class="rating-btn" title="Okay">
                  <img src="assets/emoticons-yellow.png" alt="Okay" />
                </label>

                <input type="radio" name="rating" id="rate-orange" value="Orange" />
                <label for="rate-orange" class="rating-btn" title="Meh">
                  <img src="assets/emoticons-orange.png" alt="Meh" />
                </label>

                <input type="radio" name="rating" id="rate-red" value="Red" />
                <label for="rate-red" class="rating-btn" title="Bad">
                  <img src="assets/emoticons-red.png" alt="Bad" />
                </label>
              </fieldset>

              <p><strong>Anything else?</strong></p>
              <p>
                <textarea id="extra" rows="4" placeholder="Optional"></textarea>
              </p>

              <div class="divider"></div>

              <p><strong>Screenshot (optional)</strong></p>
              <p class="muted">PNG/JPG recommended. Keep it under ~8MB.</p>

              <div class="file-row">
                <input id="screenshot" type="file" accept="image/png,image/jpeg" />
                <button
                  type="button"
                  class="file-remove"
                  id="file-remove"
                  aria-label="Remove screenshot"
                  style="display:none;"
                >
                  ×
                </button>
              </div>

              <div id="screenshot-preview-wrap" class="file-preview" style="display:none;">
                <img id="screenshot-preview" alt="Selected screenshot preview" />
              </div>

              <div class="divider"></div>

              <p>
                <button id="submit-btn" type="submit">
                  Submit Feedback
                </button>
              </p>
            </form>
          </div>

          <!-- Thank you view -->
          <div id="thankyou-view" style="display:none;">
            <h2>Thank you!</h2>
            <p class="muted">Your feedback has been sent.</p>
            <p>
              Submission ID:
              <strong id="submission-id"></strong>
            </p>

            <div class="divider"></div>

            <p class="muted">
              If you need to reference this report later, keep that ID.
            </p>

            <p style="margin-top:16px;">
              <a class="inline" href="../">Home Page</a>
              &nbsp;·&nbsp;
              <a class="inline" href="#" id="send-another">Send Another</a>
            </p>
          </div>
        </section>
      </main>

      <footer>
        © <span id="year"></span> Hollow Nexus. All rights reserved.
      </footer>
    </div>

    <!-- Loading overlay -->
    <div
      id="hn-loading"
      aria-live="polite"
      aria-atomic="true"
      style="display:none; position:fixed; inset:0; z-index:99998; background:rgba(2,2,3,0.35); backdrop-filter: blur(2px);"
    >
      <div style="min-height:100%; display:flex; align-items:center; justify-content:center; padding:18px;">
        <div
          style="display:flex; gap:12px; align-items:center; max-width:min(92vw, 520px); width:fit-content; background:rgba(248,247,255,0.92); border:1px solid rgba(2,2,3,0.14); border-radius:18px; box-shadow:0 18px 40px rgba(0,0,0,0.22); padding:14px 16px;"
          role="status"
        >
          <div
            aria-hidden="true"
            style="width:18px; height:18px; border-radius:999px; border:3px solid rgba(86,49,20,0.25); border-top-color: rgba(86,49,20,0.95); animation: hnspin 0.9s linear infinite;"
          ></div>

          <div>
            <div style="font-size:18px; letter-spacing:0.3px;">Sending feedback…</div>
            <div class="muted" style="font-size:15px; margin-top:2px;">Please wait.</div>
          </div>
        </div>
      </div>
    </div>

    <style>
      @keyframes hnspin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>

    <script>
      document.getElementById("year").textContent = String(new Date().getFullYear());
    </script>

    <script>
      const ENDPOINT_URL =
        "https://script.google.com/macros/s/AKfycbzACEqiw5gQaTZWEW6Xg8E_OmZC_lFH5zjVwMRKiG-9Hhk90palta1hHJHxva9XUlI/exec";

      const SUBTYPES = {
        "Bug Report": ["Crashes", "Freeze or Lag", "Visual or Graphical Glitch", "Audio", "Other"],
        "Graphical & User Interface": ["HUD", "Menus", "Buttons", "Sizing", "Other"],
        "Feature Request": [], // handled as N/A
        "User Experience": ["Navigation & Controls", "Game Feel & Accessibility", "Auditory Feedback", "Other"],
      };

      function setSubtypes(category) {
        const sub = document.getElementById("subcategory");
        sub.innerHTML = "";

        if (!category) {
          sub.disabled = true;
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Select a Type first…";
          sub.appendChild(opt);
          return;
        }

        if (category === "Feature Request") {
          sub.disabled = true;
          const opt = document.createElement("option");
          opt.value = "N/A";
          opt.textContent = "N/A";
          opt.selected = true;
          sub.appendChild(opt);
          return;
        }

        const list = SUBTYPES[category] || [];
        sub.disabled = false;

        const first = document.createElement("option");
        first.value = "";
        first.textContent = "Select…";
        sub.appendChild(first);

        for (const item of list) {
          const opt = document.createElement("option");
          opt.value = item;
          opt.textContent = item;
          sub.appendChild(opt);
        }
      }

      function makeClientKey() {
        const keyName = "hn_feedback_client_key";
        let key = localStorage.getItem(keyName);
        if (!key) {
          key = "ck_" + Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
          localStorage.setItem(keyName, key);
        }
        return key;
      }

      function makeClientSubmissionId() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let out = "HN-";
        for (let i = 0; i < 8; i++) {
          out += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return out;
      }

      async function fileToDataUrl(file) {
        return await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(String(reader.result));
          reader.onerror = () => reject(new Error("File read failed"));
          reader.readAsDataURL(file);
        });
      }

      function setLoading(isLoading) {
        const overlay = document.getElementById("hn-loading");
        const btn = document.getElementById("submit-btn");

        if (overlay) {
          overlay.style.display = isLoading ? "block" : "none";
        }

        if (btn) {
          btn.disabled = isLoading;
        }
      }

      // Screenshot UI
      function clearScreenshotUi() {
        const input = document.getElementById("screenshot");
        const removeBtn = document.getElementById("file-remove");
        const wrap = document.getElementById("screenshot-preview-wrap");
        const img = document.getElementById("screenshot-preview");

        if (input) input.value = "";
        if (img) img.removeAttribute("src");
        if (wrap) wrap.style.display = "none";
        if (removeBtn) removeBtn.style.display = "none";
      }

      function setScreenshotUi(dataUrl) {
        const removeBtn = document.getElementById("file-remove");
        const wrap = document.getElementById("screenshot-preview-wrap");
        const img = document.getElementById("screenshot-preview");

        if (img) img.src = dataUrl;
        if (wrap) wrap.style.display = "block";
        if (removeBtn) removeBtn.style.display = "inline-flex";
      }

      document.getElementById("category").addEventListener("change", (e) => {
        setSubtypes(e.target.value);
      });

      document.getElementById("screenshot").addEventListener("change", async (e) => {
        const input = e.target;
        const file = input.files && input.files.length > 0 ? input.files[0] : null;

        if (!file) {
          clearScreenshotUi();
          return;
        }

        const maxBytes = 8 * 1024 * 1024;
        if (file.size > maxBytes) {
          alert("Screenshot too large. Please keep under ~8MB.");
          clearScreenshotUi();
          return;
        }

        try {
          const dataUrl = await fileToDataUrl(file);
          setScreenshotUi(dataUrl);
        } catch {
          clearScreenshotUi();
        }
      });

      document.getElementById("file-remove").addEventListener("click", () => {
        clearScreenshotUi();
      });

      document.getElementById("send-another").addEventListener("click", (e) => {
        e.preventDefault();
        setLoading(false);
        clearScreenshotUi();

        document.getElementById("feedback-intro").style.display = "block";
        document.getElementById("thankyou-view").style.display = "none";
        document.getElementById("form-view").style.display = "block";

        document.getElementById("feedback-form").reset();
        setSubtypes("");
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      document.getElementById("feedback-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const fileInput = document.getElementById("screenshot");
        const file = fileInput.files && fileInput.files.length > 0 ? fileInput.files[0] : null;

        let screenshot = null;
        if (file) {
          const maxBytes = 8 * 1024 * 1024;
          if (file.size > maxBytes) {
            alert("Screenshot too large. Please keep under ~8MB.");
            return;
          }

          const dataUrl = await fileToDataUrl(file);
          screenshot = {
            filename: file.name,
            mime: file.type,
            data: dataUrl,
          };
        }

        const submissionId = makeClientSubmissionId();
        const ratingEl = document.querySelector('input[name="rating"]:checked');
        const ratingValue = ratingEl ? ratingEl.value : "";

        const payload = {
          honey: document.getElementById("honey").value,

          submissionId: submissionId,
          clientKey: makeClientKey(),

          name: document.getElementById("name").value,
          email: document.getElementById("email").value,

          game: document.getElementById("game").value,
          build: document.getElementById("build").value,

          category: document.getElementById("category").value,
          subcategory: document.getElementById("subcategory").value,
          details: document.getElementById("details").value,

          enjoyed: document.getElementById("enjoyed").value,
          playAgain: document.getElementById("playAgain").value,
          recommend: document.getElementById("recommend").value,
          rating: ratingValue,
          extra: document.getElementById("extra").value,

          screenshot: screenshot,
        };

        setLoading(true);

        try {
          await fetch(ENDPOINT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            mode: "no-cors",
          });

          setLoading(false);

          document.getElementById("submission-id").textContent = submissionId;
          document.getElementById("feedback-intro").style.display = "none";
          document.getElementById("form-view").style.display = "none";
          document.getElementById("thankyou-view").style.display = "block";
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (err) {
          setLoading(false);
          alert("Failed to submit. Please try again.");
        }
      });

      // Initialize state
      setSubtypes("");
      clearScreenshotUi();
    </script>
  </body>
</html>